#!/usr/bin/env python

import io, optparse, os, sys

from skadi.io import protobuf
from skadi import mutators, world

pwd  = os.path.dirname(__file__)
root = os.path.join(pwd, '..')
sys.path.append(root)

option_parser   = optparse.OptionParser()
(options, args) = option_parser.parse_args()

for arg in args:
    stream  = io.open(os.path.join(root, arg), 'r+b')
    demo_io = protobuf.DemoIO.wrapping(stream.read())
    world   = world.World()

    mutators = {
        'CDemoFileHeader':   mutators.parse_file_header,
        'CDemoPacket':       mutators.parse_packet,
        'CDemoSendTables':   mutators.parse_send_tables,
        'CDemoClassInfo':    mutators.parse_class_info,
        'CDemoStringTables': mutators.parse_string_tables
    }

    m = demo_io.read_message()
    while m.__class__.__name__ != 'CDemoSyncTick':
        mutators[m.__class__.__name__](world)
        m = demo_io.read_message()

    world.flatten_send_tables()