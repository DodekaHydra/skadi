#!/usr/bin/env python

import io
import math
import optparse
import os
import sys

pwd = os.path.dirname(__file__)
root = os.path.join(pwd, '..')
sys.path.append(root)

from skadi import meta as m
from skadi import replay as r
from skadi.index import demo as idx_demo

option_parser = optparse.OptionParser()
(options, args) = option_parser.parse_args()

HEADER = "PBUFDEM\0"


class InvalidDemo(RuntimeError):
  pass


for arg in args:
  print '> parsing {0}'.format(os.path.basename(arg))

  f_io = io.open(os.path.join(root, arg), 'r+b')
  if f_io.read(len(HEADER)) != HEADER:
    raise InvalidDemo('malformed header')
  f_io.read(4) # game summary offset in bytes, in file.

  index = idx_demo.construct(f_io)

  meta = m.construct(index.prologue, f_io)
  replay = r.construct(meta, index.match, f_io, tick=70000)

  for index, entity in replay.snapshot.entities.items():
    print '  #{0}: {1}'.format(index, entity.template.recv_table.dt)
    for prop, value in iter(entity):
      print '    {0}: {1}'.format(prop, value)

  print 'going earlier in the replay...'

  replay.tick = 30
  for index, entity in replay.snapshot.entities.items():
    print '  #{0}: {1}'.format(index, entity.template.recv_table.dt)
    for prop, value in iter(entity):
      print '    {0}: {1}'.format(prop, value)
