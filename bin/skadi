#!/usr/bin/env python

import io as _io
import optparse
import os
import sys

pwd = os.path.dirname(__file__)
root = os.path.abspath(os.path.join(pwd, '..'))
sys.path.append(root)

from skadi import *
from skadi import demo as d
from skadi.engine import world as w


option_parser = optparse.OptionParser()
(options, args) = option_parser.parse_args()

path = args[0]

print '> opening {0}'.format(os.path.basename(path))

with _io.open(path, 'r+b') as infile:
  demo = d.construct(load(infile), infile)

  for game in demo.stream(tick=5000):
    tick, user_msgs, game_evts, world, modifiers = game

    print tick

    # Print all active modifiers at every tick.
    for ehandle, m_list in modifiers:
      try:
        pretty = map(lambda (_, a): a['name'], m_list.items())
        dt = world.fetch_recv_table(ehandle).dt
        print '  {dt} (#{eh}): {attrs}'.format(dt=dt, eh=ehandle, attrs=pretty)
      except KeyError:
        # Unfortunately, the modifiers data is kind of messy.
        # Sometimes there are modifiers for entities that don't exist.
        # This is probably something the game client ignores.
        # Working on it!
        pass
